<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–º–æ—â—å –≤ –¢—é–º–µ–Ω–∏</title>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .hidden {
            display: none !important;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            padding: 2rem 0;
        }

        /* –ü–æ–∏—Å–∫ */
        .search-section {
            margin-bottom: 2rem;
        }

        .search-container {
            display: flex;
            gap: 10px;
        }

        .search-container input {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .search-container button {
            padding: 15px 25px;
            background-color: #2575fc;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .search-container button:hover {
            background-color: #1c6ae4;
        }

        .suggestions {
            margin-top: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: calc(90% - 30px);
            max-width: calc(1200px - 30px);
            z-index: 1000;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggestion-item:hover {
            background-color: #f1f1f1;
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .categories-section {
            margin-bottom: 2rem;
        }

        .categories-section h2 {
            margin-bottom: 1rem;
            text-align: center;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .category-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .category-card h3 {
            margin-top: 10px;
            font-size: 1.1rem;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
        .results-section {
            position: relative;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2575fc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .org-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .org-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .org-card-content {
            padding: 20px;
        }

        .org-card h3 {
            margin-bottom: 10px;
            color: #2575fc;
        }

        .org-card .org-name {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .org-card p {
            color: #555;
            font-size: 0.95rem;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø—Ä–æ—Å–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 30px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        .survey-content h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #2575fc;
        }

        .survey-step {
            display: none;
        }

        .survey-step.active {
            display: block;
        }

        .question {
            text-align: center;
        }

        .question h3 {
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
        }

        .option {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f1f1f1;
            border: none;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .option:hover {
            background-color: #e0e0e0;
        }

        .back-btn {
            background: none;
            border: none;
            color: #2575fc;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 15px;
            text-align: left;
            width: 100%;
        }

        textarea {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ */
        .org-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .org-page.active {
            display: flex;
        }

        .org-page-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 30px;
        }

        .org-details h2 {
            color: #2575fc;
            margin-bottom: 1rem;
        }

        .org-details .main-service {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .org-details .org-name {
            font-size: 1rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .org-details p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .org-details .contact-person {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .org-details .contact-person h3 {
            margin-bottom: 1rem;
            color: #2575fc;
        }

        .person-card {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .person-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .person-info strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .person-info div {
            margin-bottom: 3px;
            font-size: 0.95rem;
        }

        #yandexMap {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            border-radius: 8px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .categories-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .org-page-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
    <!-- Yandex.Maps API -->
    <script src="https://api-maps.yandex.ru/2.1/?apikey=YOUR_YANDEX_MAPS_API_KEY&lang=ru_RU" async></script>
</head>
<body>
    <!-- –®–∞–ø–∫–∞ -->
    <header class="header">
        <div class="container">
            <h1>–ü–æ–º–æ—â—å –≤ –¢—é–º–µ–Ω–∏</h1>
            <p>–ù–∞–π–¥–∏—Ç–µ –Ω—É–∂–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ —É—Å–ª—É–≥–∏ –≤ –≤–∞—à–µ–º –≥–æ—Ä–æ–¥–µ</p>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="main-content">
        <div class="container">
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-section">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="–ß—Ç–æ –≤—ã –∏—â–µ—Ç–µ? –ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å, —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è...">
                    <button onclick="performSearch()">–ù–∞–π—Ç–∏</button>
                </div>
                <div id="searchSuggestions" class="suggestions"></div>
            </div>

            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
            <div class="categories-section">
                <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥</h2>
                <div class="categories-grid" id="categoriesGrid">
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å—é–¥–∞ -->
                </div>
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
            <div class="results-section">
                <div id="loadingIndicator" class="loading hidden">
                    <div class="spinner"></div>
                </div>
                <div id="errorMessage" class="error-message hidden"></div>
                <div id="resultsContainer" class="results-grid">
                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø—Ä–æ—Å–∞ -->
    <div id="surveyModal" class="modal hidden">
        <div class="modal-content survey-content">
            <span class="close" onclick="closeSurvey()">&times;</span>
            <h2>–ü–æ–¥–±–µ—Ä–µ–º –Ω—É–∂–Ω—É—é –ø–æ–º–æ—â—å</h2>
            
            <!-- –®–∞–≥ 1 -->
            <div class="survey-step active" id="step1">
                <div class="question">
                    <h3>–ö—Ç–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ø–æ–º–æ—â–∏?</h3>
                    <button class="option" onclick="nextStep(2, 'me')">–Ø —Å–∞–º</button>
                    <button class="option" onclick="nextStep(2, 'my_child')">–ú–æ–π —Ä–µ–±–µ–Ω–æ–∫</button>
                    <button class="option" onclick="nextStep(2, 'family')">–°–µ–º—å—è</button>
                    <button class="option" onclick="nextStep(2, 'other')">–ö—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π</button>
                </div>
            </div>

            <!-- –®–∞–≥ 2 -->
            <div class="survey-step" id="step2">
                <div class="question">
                    <button class="back-btn" onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>
                    <h3>–í –∫–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –≤—ã –æ–∫–∞–∑–∞–ª–∏—Å—å?</h3>
                    <button class="option" onclick="nextStep(3, 'legal')">–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</button>
                    <button class="option" onclick="nextStep(3, 'psychology')">–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏</button>
                    <button class="option" onclick="nextStep(3, 'social')">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</button>
                    <button class="option" onclick="nextStep(3, 'health')">–ü—Ä–æ–±–ª–µ–º—ã —Å–æ –∑–¥–æ—Ä–æ–≤—å–µ–º</button>
                    <button class="option" onclick="nextStep(3, 'other')">–î—Ä—É–≥–æ–µ</button>
                </div>
            </div>

            <!-- –®–∞–≥ 3 -->
            <div class="survey-step" id="step3">
                <div class="question">
                    <button class="back-btn" onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>
                    <h3>–ö–∞–∫–∞—è –ø–æ–º–æ—â—å –≤–∞–º –Ω—É–∂–Ω–∞?</h3>
                    <button class="option" onclick="nextStep(4, 'consultation')">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</button>
                    <button class="option" onclick="nextStep(4, 'support')">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
                    <button class="option" onclick="nextStep(4, 'service')">–£—Å–ª—É–≥–∞</button>
                    <button class="option" onclick="nextStep(4, 'other')">–î—Ä—É–≥–æ–µ</button>
                </div>
            </div>

            <!-- –®–∞–≥ 4 -->
            <div class="survey-step" id="step4">
                <div class="question">
                    <button class="back-btn" onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>
                    <h3>–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞</h3>
                    <div id="specificOptions">
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –ø–æ–¥–≥—Ä—É–∂–µ–Ω—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —à–∞–≥–∞ 2 -->
                    </div>
                    <button class="option" onclick="nextStep(5, 'other')">–î—Ä—É–≥–æ–µ</button>
                </div>
            </div>

            <!-- –®–∞–≥ 5 -->
            <div class="survey-step" id="step5">
                <div class="question">
                    <button class="back-btn" onclick="prevStep()">‚Üê –ù–∞–∑–∞–¥</button>
                    <h3>–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è?</h3>
                    <textarea id="additionalInfo" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å –Ω–∞ –¥–æ–º—É, –≤–∞–∂–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Ç.–¥."></textarea>
                    <button class="option" onclick="submitSurvey()">–ù–∞–π—Ç–∏ –ø–æ–º–æ—â—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
    <div id="orgPage" class="org-page">
        <div class="org-page-content">
            <span class="close" onclick="closeOrgPage()">&times;</span>
            <div id="orgDetails">
                <!-- –î–µ—Ç–∞–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <script>
        // –ë–∞–∑–æ–≤—ã–π URL API
        const API_BASE_URL = 'http://82.202.140.221:5000/api';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentStep = 1;
        let surveyData = {};
        let categories = [];

        // DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadAllOrganizations();
            setupSearchSuggestions();
            openSurvey();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        });

    

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        async function loadCategories() {
            try {
                const data = await apiRequest('/categories');
                categories = data.categories || data || [];
                displayCategories();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function displayCategories() {
            const container = document.getElementById('categoriesGrid');
            container.innerHTML = categories.map(category => `
                <div class="category-card" onclick="loadOrganizationsByCategory('${category.name}')">
                    <h3>${category.name}</h3>
                    <p>${category.organization_count || 0} —É—Å–ª—É–≥</p>
                </div>
            `).join('');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
        async function loadAllOrganizations() {
            try {
                showLoading(true);
                const data = await apiRequest('/organizations');
                displayResults(data.organizations);
                hideError();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            } finally {
                showLoading(false);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        async function loadOrganizationsByCategory(category) {
            try {
                showLoading(true);
                const data = await apiRequest(`/organizations?category=${encodeURIComponent(category)}`);
                displayResults(data.organizations);
                hideError();
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            } finally {
                showLoading(false);
            }
        }

        // –ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
        async function searchOrganizations(query) {
            try {
                showLoading(true);
                const data = await apiRequest(`/search?q=${encodeURIComponent(query)}`);
                displayResults(data.organizations);
                hideError();
                if (data.organizations.length === 0) {
                    showError(`–ü–æ –∑–∞–ø—Ä–æ—Å—É "${query}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.`);
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            } finally {
                showLoading(false);
            }
        }

        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                loadAllOrganizations();
                return;
            }
            document.getElementById('searchSuggestions').style.display = 'none';
            await searchOrganizations(query);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function displayResults(organizations) {
            const container = document.getElementById('resultsContainer');
            if (!organizations || organizations.length === 0) {
                container.innerHTML = '<p class="no-results">–£—Å–ª—É–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            container.innerHTML = organizations.map(org => `
                <div class="org-card" onclick="showOrganizationDetails(${org.id})">
                    <div class="org-card-content">
                        <h3>${org.main_service || org.name}</h3>
                        ${org.main_service ? `<p class="org-name">–≤ ${org.name}</p>` : ''}
                        <p>${org.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                        ${org.category ? `<p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${org.category}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        async function showOrganizationDetails(id) {
            try {
                const organization = await getOrganizationDetails(id);
                const orgPage = document.getElementById('orgPage');
                const orgDetails = document.getElementById('orgDetails');
                
                orgDetails.innerHTML = `
                    <div class="org-details">
                        <h2>${organization.name}</h2>
                        ${organization.main_service ? `<div class="main-service">${organization.main_service}</div>` : ''}
                        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${organization.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–ê–¥—Ä–µ—Å:</strong> ${organization.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        ${organization.phone ? `<p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${organization.phone}</p>` : ''}
                        ${organization.email ? `<p><strong>Email:</strong> ${organization.email}</p>` : ''}
                        ${organization.website ? `<p><strong>–°–∞–π—Ç:</strong> <a href="${organization.website}" target="_blank">${organization.website}</a></p>` : ''}
                        ${organization.services ? `<p><strong>–£—Å–ª—É–≥–∏:</strong> ${organization.services}</p>` : ''}
                        
                        ${organization.contact_person_name ? `
                        <div class="contact-person">
                            <h3>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</h3>
                            <div class="person-card">
                                ${organization.contact_person_photo_url ? 
                                    `<img src="${organization.contact_person_photo_url}" alt="${organization.contact_person_name}" class="person-photo">` : 
                                    '<div class="person-photo" style="background:#eee;width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;">üë§</div>'
                                }
                                <div class="person-info">
                                    <strong>${organization.contact_person_name}</strong>
                                    <div>${organization.contact_person_role || '–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ'}</div>
                                    ${organization.contact_person_phone ? `<div>üìû ${organization.contact_person_phone}</div>` : ''}
                                    ${organization.contact_person_email ? `<div>‚úâÔ∏è ${organization.contact_person_email}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${organization.address ? `<div id="yandexMap"></div>` : ''}
                    </div>
                `;
                
                orgPage.classList.add('active');
                document.body.classList.add('org-page-active');
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–¥—Ä–µ—Å
                if (organization.address) {
                    setTimeout(() => showYandexMap(organization.address), 500);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        function closeOrgPage() {
            document.getElementById('orgPage').classList.remove('active');
            document.body.classList.remove('org-page-active');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—É
        function showYandexMap(address) {
            if (typeof ymaps === 'undefined') {
                console.warn('Yandex Maps API not loaded yet');
                return;
            }
            
            ymaps.ready(() => {
                const geocodePromise = ymaps.geocode(address);
                geocodePromise.then(res => {
                    const coords = res.geoObjects.get(0).geometry.getCoordinates();
                    const map = new ymaps.Map('yandexMap', {
                        center: coords,
                        zoom: 15,
                        controls: ['zoomControl']
                    });
                    
                    const placemark = new ymaps.Placemark(coords, {
                        balloonContent: address
                    });
                    
                    map.geoObjects.add(placemark);
                    map.behaviors.disable('scrollZoom');
                }).catch(err => {
                    console.error('Geocoding error:', err);
                    document.getElementById('yandexMap').innerHTML = '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞—Ä—Ç—É</p>';
                });
            });
        }

        // –û–ø—Ä–æ—Å
        function openSurvey() {
            document.getElementById('surveyModal').classList.remove('hidden');
            currentStep = 1;
            surveyData = {};
            document.querySelectorAll('.survey-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
        }

        function closeSurvey() {
            document.getElementById('surveyModal').classList.add('hidden');
        }

        function nextStep(step, value) {
            surveyData[`step${currentStep}`] = value;
            
            if (step === 3) {
                showSpecificOptions(value);
            }
            
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
        }

        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
            }
        }

        function showSpecificOptions(helpType) {
            const specificOptions = document.getElementById('specificOptions');
            let options = '';
            
            switch(helpType) {
                case 'legal':
                    options = `
                        <button class="option" onclick="nextStep(5, 'social_support')">üèõÔ∏è –ú–µ—Ä—ã —Å–æ—Ü –ø–æ–¥–¥–µ—Ä–∂–∫–∏</button>
                        <button class="option" onclick="nextStep(5, 'custody')">üë®‚Äçüë©‚Äçüëß –û–ø–µ–∫—É–Ω—Å—Ç–≤–æ, —É—Å—ã–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                        <button class="option" onclick="nextStep(5, 'divorce')">üíî –†–∞–∑–≤–æ–¥—ã</button>
                        <button class="option" onclick="nextStep(5, 'housing')">üè† –ñ–∏–ª—å–µ</button>
                        <button class="option" onclick="nextStep(5, 'documents')">üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã</button>
                    `;
                    break;
                case 'psychology':
                    options = `
                        <button class="option" onclick="nextStep(5, 'anxiety')">üò∞ –¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å, —Å—Ç—Ä–µ—Å—Å</button>
                        <button class="option" onclick="nextStep(5, 'depression')">üòû –î–µ–ø—Ä–µ—Å—Å–∏—è</button>
                        <button class="option" onclick="nextStep(5, 'family_conflicts')">üë®‚Äçüë©‚Äçüëß –°–µ–º–µ–π–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã</button>
                        <button class="option" onclick="nextStep(5, 'grief')">üò¢ –ü–æ—Ç–µ—Ä–∏, –≥–æ—Ä–µ</button>
                        <button class="option" onclick="nextStep(5, 'addiction')">üç∑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</button>
                    `;
                    break;
                case 'social':
                    options = `
                        <button class="option" onclick="nextStep(5, 'benefits')">üí∞ –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –ª—å–≥–æ—Ç—ã, –≤—ã–ø–ª–∞—Ç—ã</button>
                        <button class="option" onclick="nextStep(5, 'disability')">‚ôø –ò–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å</button>
                        <button class="option" onclick="nextStep(5, 'elderly')">üßì –ü–æ–∂–∏–ª—ã–º –ª—é–¥—è–º</button>
                        <button class="option" onclick="nextStep(5, 'migrants')">üåç –ú–∏–≥—Ä–∞–Ω—Ç–∞–º</button>
                        <button class="option" onclick="nextStep(5, 'homeless')">üè† –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∂–∏–ª—å–µ</button>
                    `;
                    break;
                case 'health':
                    options = `
                        <button class="option" onclick="nextStep(5, 'medical_care')">üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å</button>
                        <button class="option" onclick="nextStep(5, 'rehabilitation')">ü¶Ω –†–µ–∞–±–∏–ª–∏—Ç–∞—Ü–∏—è</button>
                        <button class="option" onclick="nextStep(5, 'disability_support')">‚ôø –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω–≤–∞–ª–∏–¥–æ–≤</button>
                        <button class="option" onclick="nextStep(5, 'mental_health')">üß† –ü—Å–∏—Ö–∏—á–µ—Å–∫–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ</button>
                        <button class="option" onclick="nextStep(5, 'addiction_treatment')">üç∑ –õ–µ—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π</button>
                    `;
                    break;
                default:
                    options = '<p>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è</p>';
            }
            
            specificOptions.innerHTML = options;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤ –≤ –æ–ø—Ä–æ—Å–µ
        function generateSurveyQuery(data) {
            let queryParts = [];
            
            // –ö—Ç–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –ø–æ–º–æ—â–∏
            switch(data.step1) {
                case 'me': queryParts.push("–¥–ª—è —Å–µ–±—è"); break;
                case 'my_child': queryParts.push("–¥–ª—è —Ä–µ–±–µ–Ω–∫–∞"); break;
                case 'family': queryParts.push("–¥–ª—è —Å–µ–º—å–∏"); break;
                case 'other': queryParts.push("–¥–ª—è –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞"); break;
            }
            
            // –°–∏—Ç—É–∞—Ü–∏—è
            switch(data.step2) {
                case 'legal': queryParts.push("—é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å"); break;
                case 'psychology': queryParts.push("–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å"); break;
                case 'social': queryParts.push("—Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞"); break;
                case 'health': queryParts.push("–º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å"); break;
                case 'other': queryParts.push("—Ä–∞–∑–Ω–∞—è –ø–æ–º–æ—â—å"); break;
            }
            
            // –¢–∏–ø –ø–æ–º–æ—â–∏
            switch(data.step3) {
                case 'consultation': queryParts.push("–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"); break;
                case 'support': queryParts.push("–ø–æ–¥–¥–µ—Ä–∂–∫–∞"); break;
                case 'service': queryParts.push("—É—Å–ª—É–≥–∞"); break;
                case 'other': queryParts.push("–¥—Ä—É–≥–∞—è –ø–æ–º–æ—â—å"); break;
            }
            
            // –£—Ç–æ—á–Ω–µ–Ω–∏–µ
            if (data.step4 && data.step4 !== 'other') {
                queryParts.push(data.step4);
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            if (data.step5) {
                queryParts.push(data.step5);
            }
            
            return queryParts.join(", ") || "–ø–æ–∏—Å–∫ –ø–æ–º–æ—â–∏";
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–ø—Ä–æ—Å–∞
        async function submitSurvey() {
            const queryText = generateSurveyQuery(surveyData);
            showLoading(true);
            
            try {
                const data = await apiRequest(`/search?q=${encodeURIComponent(queryText)}`);
                displayResults(data.organizations);
                hideError();
                closeSurvey();
            } catch (error) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —É—Å–ª—É–≥–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.');
            } finally {
                showLoading(false);
            }
        }

        // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
        function setupSearchSuggestions() {
            const searchInput = document.getElementById('searchInput');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            const suggestions = [
                '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å',
                '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏',
                '–ü–æ–º–æ—â—å –¥–µ—Ç—è–º',
                '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
                '–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—Ç–≤–æ',
                '–ü–æ–º–æ—â—å –ø–æ –°–í–û',
                '–õ—å–≥–æ—Ç—ã –∏ –≤—ã–ø–ª–∞—Ç—ã',
                '–°–µ–º–µ–π–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è'
            ];
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                const filtered = suggestions.filter(s => s.toLowerCase().includes(query));
                if (filtered.length > 0) {
                    suggestionsContainer.innerHTML = filtered.map(s => 
                        `<div class="suggestion-item" onclick="selectSuggestion('${s}')">${s}</div>`
                    ).join('');
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            // –ó–∞–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        function selectSuggestion(text) {
            document.getElementById('searchInput').value = text;
            document.getElementById('searchSuggestions').style.display = 'none';
            performSearch();
        }

        // API —Ñ—É–Ω–∫—Ü–∏–∏
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // UI —Ñ—É–Ω–∫—Ü–∏–∏
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        if ('ontouchstart' in window || navigator.maxTouchPoints) {
            document.body.classList.add('touch-device');
        }

        // –£–ª—É—á—à–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        document.addEventListener('touchstart', function(e) {
            if (e.target.closest('#yandexMap')) {
                e.stopPropagation();
            }
        }, { passive: true });

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
        document.addEventListener('scroll', function(e) {
            if (document.getElementById('orgPage').classList.contains('active')) {
                e.stopPropagation();
            }
        }, { passive: true });
    </script>
</body>
</html>

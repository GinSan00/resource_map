<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора</title>
    <style>
        /* Общие стили */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .d-none {
            display: none !important;
        }

        /* Форма авторизации */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }

        .login-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #2575fc;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #2575fc;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1c6ae4;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Админ-панель */
        .admin-panel {
            display: flex;
            min-height: 100vh;
        }

        /* Боковая навигация */
        .sidebar {
            width: 250px;
            background-color: #343a40;
            color: white;
            padding: 20px 0;
        }

        .sidebar h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: #fff;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar ul li {
            margin-bottom: 5px;
        }

        .sidebar ul li a {
            display: block;
            padding: 10px 20px;
            color: #ccc;
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background-color: #007bff;
            color: white;
        }

        /* Основной контент */
        .main-content {
            flex: 1;
            padding: 20px;
            background-color: #f8f9fa;
        }

        .content-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            margin: 0;
            color: #2575fc;
        }

        /* Статистика */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #e9ecef;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .stat-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2575fc;
        }

        /* Таблицы */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table th {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .table tr:hover {
            background-color: #f8f9fa;
        }

        /* Фильтры */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
        }

        .filters input,
        .filters select,
        .filters button {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-family: inherit;
        }

        .filters input {
            flex: 1;
            min-width: 200px;
        }

        /* Пагинация */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }

        .pagination button.active {
            background-color: #007bff;
            color: white;
        }

        .pagination button:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        /* Алерты */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-success {
            background-color: #28a745;
            color: white;
        }

        .badge-danger {
            background-color: #dc3545;
            color: white;
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            padding: 30px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .admin-panel {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 10px 0;
            }
            
            .sidebar ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .sidebar ul li {
                margin: 5px;
            }
            
            .sidebar ul li a {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filters input,
            .filters select {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Форма авторизации -->
    <div id="loginContainer" class="login-container">
        <form id="loginForm" class="login-form">
            <h2>Вход в панель администратора</h2>
            <div id="loginAlert" class="alert alert-error d-none"></div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="password">Пароль</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Войти</button>
        </form>
    </div>

    <!-- Основная панель -->
    <div id="adminPanel" class="admin-panel d-none">
        <!-- Навигация -->
        <nav class="sidebar">
            <h2>Админ-панель</h2>
            <ul>
                <li><a href="#" class="nav-link active" data-target="dashboard">Дашборд</a></li>
                <li><a href="#" class="nav-link" data-target="organizations">Организации</a></li>
                <li><a href="#" class="nav-link" data-target="categories">Категории</a></li>
                <li><a href="#" class="nav-link" data-target="pending">Заявки владельцев</a></li>
                <li><a href="#" class="nav-link" data-target="org-add-requests">Заявки на добавление</a></li>
                <li><a href="#" class="nav-link" data-target="owners">Владельцы</a></li>
                <li><a href="#" id="logoutBtn">Выход</a></li>
            </ul>
        </nav>

        <!-- Основной контент -->
        <main class="main-content">
            <!-- Дашборд -->
            <section id="dashboardSection" class="content-section">
                <h2>Дашборд</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Всего организаций</h3>
                        <p id="totalOrganizations">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Активных</h3>
                        <p id="activeOrganizations">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Неактивных</h3>
                        <p id="inactiveOrganizations">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Категорий</h3>
                        <p id="totalCategories">0</p>
                    </div>
                </div>
                <h3>Последние добавленные организации</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Категория</th>
                            <th>Дата создания</th>
                        </tr>
                    </thead>
                    <tbody id="recentOrganizations">
                        <!-- Будет заполнено динамически -->
                    </tbody>
                </table>
            </section>

            <!-- Организации -->
            <section id="organizationsSection" class="content-section d-none">
                <div class="section-header">
                    <h2>Организации</h2>
                    <button class="btn btn-primary" onclick="openAddOrganizationModal()">Добавить организацию</button>
                </div>
                
                <!-- Фильтры -->
                <div class="filters">
                    <input type="text" id="searchInput" placeholder="Поиск по названию...">
                    <select id="categoryFilter">
                        <option value="">Все категории</option>
                    </select>
                    <select id="statusFilter">
                        <option value="all">Все статусы</option>
                        <option value="active">Активные</option>
                        <option value="inactive">Неактивные</option>
                    </select>
                    <button class="btn btn-secondary" onclick="applyFilters()">Применить</button>
                </div>

                <!-- Таблица организаций -->
                <div id="organizationsAlert" class="alert d-none"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Название</th>
                            <th>Главная услуга</th>
                            <th>Категория</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="organizationsTable">
                        <!-- Будет заполнено динамически -->
                    </tbody>
                </table>

                <!-- Пагинация -->
                <div class="pagination" id="pagination">
                    <!-- Будет заполнено динамически -->
                </div>
            </section>

            <!-- Категории -->
            <section id="categoriesSection" class="content-section d-none">
                <div class="section-header">
                    <h2>Категории</h2>
                    <button class="btn btn-primary" onclick="openAddCategoryModal()">Добавить категорию</button>
                </div>
                
                <div id="categoriesAlert" class="alert d-none"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Название</th>
                            <th>Описание</th>
                            <th>Кол-во организаций</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTable">
                        <!-- Будет заполнено динамически -->
                    </tbody>
                </table>
            </section>

            <!-- Заявки -->
            <section id="pendingSection" class="content-section d-none">
                <h2>Заявки на модерацию</h2>
                <div id="pendingAlert" class="alert d-none"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Тип</th>
                            <th>Email владельца</th>
                            <th>Статус</th>
                            <th>Дата</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTable">
                        <!-- Будет заполнено динамически -->
                    </tbody>
                </table>
            </section>

            <!-- Заявки на добавление организаций -->
            <section id="org-add-requestsSection" class="content-section d-none">
                <h2>Заявки на добавление организаций</h2>
                <div id="orgAddRequestsAlert" class="alert d-none"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Название организации</th>
                            <th>Категория</th>
                            <th>Заявитель</th>
                            <th>Статус</th>
                            <th>Дата</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="orgAddRequestsTable">
                        <!-- Будет заполнено динамически -->
                    </tbody>
                </table>
            </section>

            <!-- Владельцы -->
            <section id="ownersSection" class="content-section d-none">
                <h2>Владельцы организаций</h2>
                <div id="ownersAlert" class="alert d-none"></div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ФИО</th>
                            <th>Email</th>
                            <th>Организация</th>
                            <th>Статус</th>
                            <th>Дата регистрации</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="ownersTable">
                        <!-- Будет заполнено динамически -->
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- Модальное окно организации -->
    <div id="organizationModal" class="modal d-none">
        <div class="modal-content">
            <span class="close" onclick="closeOrganizationModal()">&times;</span>
            <h2 id="modalTitle">Добавить организацию</h2>
            <div id="organizationAlert" class="alert d-none"></div>
            <form id="organizationForm">
                <input type="hidden" id="orgId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="orgName">Название *</label>
                        <input type="text" id="orgName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="orgMainService">Главная услуга (отображается в результатах)</label>
                        <input type="text" id="orgMainService" name="main_service">
                    </div>
                </div>
                <div class="form-group">
                    <label for="orgCategory">Категория *</label>
                    <select id="orgCategory" name="category_id" required>
                        <option value="">Выберите категорию</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orgDescription">Описание *</label>
                    <textarea id="orgDescription" name="description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="orgAddress">Адрес</label>
                    <input type="text" id="orgAddress" name="address">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="orgPhone">Телефон</label>
                        <input type="text" id="orgPhone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="orgEmail">Email</label>
                        <input type="email" id="orgEmail" name="email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="orgWebsite">Сайт</label>
                    <input type="url" id="orgWebsite" name="website">
                </div>
                <div class="form-group">
                    <label for="orgServices">Услуги</label>
                    <textarea id="orgServices" name="services" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="orgTags">Теги (через запятую)</label>
                    <input type="text" id="orgTags" name="tags">
                </div>
                
                <h3>Контактное лицо</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="contactPersonName">ФИО</label>
                        <input type="text" id="contactPersonName" name="contact_person_name">
                    </div>
                    <div class="form-group">
                        <label for="contactPersonRole">Должность/роль</label>
                        <input type="text" id="contactPersonRole" name="contact_person_role">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="contactPersonPhone">Телефон</label>
                        <input type="text" id="contactPersonPhone" name="contact_person_phone">
                    </div>
                    <div class="form-group">
                        <label for="contactPersonEmail">Email</label>
                        <input type="email" id="contactPersonEmail" name="contact_person_email">
                    </div>
                </div>
                <div class="form-group">
                    <label for="contactPersonPhoto">Фото (ссылка)</label>
                    <input type="url" id="contactPersonPhoto" name="contact_person_photo_url">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="orgIsActive" name="is_active" checked> Активна
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно категории -->
    <div id="categoryModal" class="modal d-none">
        <div class="modal-content">
            <span class="close" onclick="closeCategoryModal()">&times;</span>
            <h2 id="categoryModalTitle">Добавить категорию</h2>
            <div id="categoryAlert" class="alert d-none"></div>
            <form id="categoryForm">
                <input type="hidden" id="categoryId">
                <div class="form-group">
                    <label for="categoryName">Название *</label>
                    <input type="text" id="categoryName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">Описание</label>
                    <textarea id="categoryDescription" name="description" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Сохранить</button>
            </form>
        </div>
    </div>

    <script>
        // Базовый URL API
        const API_BASE_URL = 'http://82.202.140.221:5000/api';

        // Состояние приложения
        let currentUser = null;
        let authToken = null;
        let currentPage = 1;
        let currentFilters = {};
        let isEditing = false;
        let categories = [];
        let pendingRequests = [];
        let organizationAddRequests = []; 

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            initEventListeners();
        });

        function initEventListeners() {
            // Авторизация
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Навигация
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', handleNavigation);
            });
            
            // Фильтры
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
            
            // Формы
            document.getElementById('organizationForm').addEventListener('submit', handleOrganizationFormSubmit);
            document.getElementById('categoryForm').addEventListener('submit', handleCategoryFormSubmit);
            
            // Закрытие модальных окон
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.add('d-none');
                }
            });
        }

        // Проверка авторизации
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                authToken = token;
                verifyToken();
            } else {
                showLogin();
            }
        }

        async function verifyToken() {
    try {
        const response = await fetch(`${API_BASE_URL}/admin/profile`, {
            headers: {'Authorization': `Bearer ${authToken}`}
        });
        if (response.ok) {
            const data = await response.json();
            currentUser = data;
            showAdminPanel(); // Сначала показываем панель → она сама обновит текст
        } else {
            localStorage.removeItem('adminToken');
            showLogin();
        }
    } catch (error) {
        console.error('Ошибка проверки токена:', error);
        localStorage.removeItem('adminToken');
        showLogin();
    }
}

        function showLogin() {
            document.getElementById('loginContainer').classList.remove('d-none');
            document.getElementById('adminPanel').classList.add('d-none');
        }

function showAdminPanel() {
    document.getElementById('loginContainer').classList.add('d-none');
    document.getElementById('adminPanel').classList.remove('d-none');
    // Теперь можно безопасно обновлять элемент
    document.getElementById('adminUsername').textContent = currentUser.email;
}

        // Авторизация
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showAlert('loginAlert', 'Заполните все поля', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.admin;
                    localStorage.setItem('adminToken', authToken);
                    showAdminPanel();
                } else {
                    showAlert('loginAlert', data.error, 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'Ошибка подключения к серверу', 'error');
            }
        }

        async function handleLogout() {
            try {
                await fetch(`${API_BASE_URL}/admin/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            } catch (error) {
                console.error('Ошибка выхода:', error);
            }
            authToken = null;
            currentUser = null;
            localStorage.removeItem('adminToken');
            showLogin();
        }

        // Навигация
        function handleNavigation(e) {
    e.preventDefault();
    const targetLink = e.target.closest('.nav-link');
    if (!targetLink) return;

    const target = targetLink.getAttribute('data-target');

    // Скрыть все секции
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('d-none');
    });

    // Показать нужную секцию
    if (target) {
        document.getElementById(`${target}Section`).classList.remove('d-none');
    }

    // Обновить активную ссылку
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
    });
    targetLink.classList.add('active');

    // Загрузить данные
    switch (target) {
        case 'dashboard': loadDashboard(); break;
        case 'organizations': loadOrganizations(1); break;
        case 'categories': loadCategories(); break;
        case 'pending': loadPendingRequests(); break;
        case 'org-add-requests': loadOrganizationAddRequests(); break;
        case 'owners': loadOwners(); break;
    }
}

        // Дашборд
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalOrganizations').textContent = data.stats.total_organizations;
                    document.getElementById('activeOrganizations').textContent = data.stats.active_organizations;
                    document.getElementById('inactiveOrganizations').textContent = data.stats.inactive_organizations;
                    document.getElementById('totalCategories').textContent = data.stats.total_categories;
                    
                    const tbody = document.getElementById('recentOrganizations');
                    tbody.innerHTML = data.recent_organizations.map(org => 
                        `<tr>
                            <td>${org.name}</td>
                            <td>${org.category}</td>
                            <td>${new Date(org.created_at).toLocaleDateString()}</td>
                        </tr>`
                    ).join('');
                } else {
                    console.error('Ошибка загрузки дашборда:', response.status, response.statusText);
                    if (response.status === 401) {
                        // Токен недействителен, перенаправить на логин
                        localStorage.removeItem('adminToken');
                        showLogin();
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки дашборда:', error);
            }
        }

        // Организации
        async function loadOrganizations(page = 1) {
            currentPage = page;
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 20,
                    search: currentFilters.search || '',
                    category_id: currentFilters.category_id || '',
                    status: currentFilters.status || 'all'
                });
                
                const response = await fetch(`${API_BASE_URL}/admin/organizations?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayOrganizations(data.organizations, data.total, data.pages);
                } else {
                    showAlert('organizationsAlert', 'Ошибка загрузки организаций', 'error');
                }
            } catch (error) {
                showAlert('organizationsAlert', 'Ошибка подключения к серверу', 'error');
            }
        }

        function displayOrganizations(organizations, total, pages) {
            const tbody = document.getElementById('organizationsTable');
            tbody.innerHTML = organizations.map(org => `
                <tr>
                    <td>${org.id}</td>
                    <td>${org.name}</td>
                    <td>${org.main_service || ''}</td>
                    <td>${org.category}</td>
                    <td>${org.is_active ? 'Активна' : 'Неактивна'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editOrganization(${org.id})">Редактировать</button>
                        <button class="btn btn-danger" onclick="deleteOrganization(${org.id})">Удалить</button>
                    </td>
                </tr>
            `).join('');
            
            // Обновить пагинацию
            updatePagination(pages);
        }

        function updatePagination(pages) {
            const container = document.getElementById('pagination');
            let pagination = '';
            
            for (let i = 1; i <= pages; i++) {
                pagination += `<button class="${i === currentPage ? 'active' : ''}" onclick="loadOrganizations(${i})">${i}</button>`;
            }
            
            container.innerHTML = pagination;
        }

        function applyFilters() {
            currentFilters = {
                search: document.getElementById('searchInput').value.trim(),
                category_id: document.getElementById('categoryFilter').value,
                status: document.getElementById('statusFilter').value
            };
            loadOrganizations(1);
        }

        // Категории
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/categories`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    categories = data.categories;
                    displayCategories();
                    updateCategorySelects();
                } else {
                    console.error('Ошибка загрузки категорий:', response.status, response.statusText);
                    if (response.status === 401) {
                        // Токен недействителен, перенаправить на логин
                        localStorage.removeItem('adminToken');
                        showLogin();
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
            }
        }

        function displayCategories() {
            const tbody = document.getElementById('categoriesTable');
            tbody.innerHTML = categories.map(category => `
                <tr>
                    <td>${category.id}</td>
                    <td>${category.name}</td>
                    <td>${category.description || ''}</td>
                    <td>${category.organization_count}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editCategory(${category.id})">Редактировать</button>
                        <button class="btn btn-danger" onclick="deleteCategory(${category.id})">Удалить</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateCategorySelects() {
            const select = document.getElementById('categoryFilter');
            const formSelect = document.getElementById('orgCategory');
            
            // Очистить селекты
            select.innerHTML = '<option value="">Все категории</option>';
            formSelect.innerHTML = '<option value="">Выберите категорию</option>';
            
            // Заполнить опциями
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option.cloneNode(true));
                formSelect.appendChild(option);
            });
        }

        // Заявки на модерацию
        async function loadPendingRequests() {
    try {
        const response = await fetch(`${API_BASE_URL}/admin/pending-requests`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
            const data = await response.json();
            // ❗ Сервер возвращает массив, а не { requests: [...] }
            pendingRequests = Array.isArray(data) ? data : [];
            displayPendingRequests();
        } else {
            showAlert('pendingAlert', 'Ошибка загрузки заявок', 'error');
        }
    } catch (error) {
        console.error('Ошибка загрузки заявок:', error);
        showAlert('pendingAlert', 'Ошибка подключения к серверу', 'error');
    }
}

        // Заявки на добавление организаций
        async function loadOrganizationAddRequests() {
    try {
        const response = await fetch(`${API_BASE_URL}/admin/organization-add-requests`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
            const data = await response.json();
            // Сервер возвращает массив
            organizationAddRequests = Array.isArray(data) ? data : [];
            displayOrganizationAddRequests(organizationAddRequests); 
        } else {
            showAlert('orgAddRequestsAlert', 'Ошибка загрузки заявок', 'error');
        }
    } catch (error) {
        console.error('Ошибка загрузки заявок на добавление организаций:', error);
        showAlert('orgAddRequestsAlert', 'Ошибка подключения к серверу', 'error');
    }
}

        // Владельцы организаций
        async function loadOwners() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/owners`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayOwners(data.owners);
                }
            } catch (error) {
                console.error('Ошибка загрузки владельцев:', error);
            }
        }

        function displayPendingRequests() {
    const tbody = document.getElementById('pendingTable');
    if (!tbody) return;

    if (!Array.isArray(pendingRequests) || pendingRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">Нет заявок</td></tr>';
        return;
    }

    tbody.innerHTML = pendingRequests.map(req => `
        <tr>
            <td>${req.id}</td>
            <td>${req.request_type}</td>
            <td>${req.owner_email}</td>
            <td>${req.status}</td>
            <td>${new Date(req.created_at).toLocaleString()}</td>
            <td>
                <button class="btn btn-success" onclick="approveRequest(${req.id})">Одобрить</button>
                <button class="btn btn-danger" onclick="rejectRequest(${req.id})">Отклонить</button>
            </td>
        </tr>
    `).join('');
}

        function displayOrganizationAddRequests(requests) {
            const tbody = document.getElementById('orgAddRequestsTable');
            tbody.innerHTML = requests.map(request => `
                <tr>
                    <td>${request.id}</td>
                    <td>${request.organization_name}</td>
                    <td>${request.category_name || 'Не указана'}</td>
                    <td>${request.requester_name}<br><small>${request.requester_email}</small></td>
                    <td>${request.status}</td>
                    <td>${new Date(request.created_at).toLocaleDateString()}</td>
                    <td>
                        ${request.status === 'pending' ? `
                            <button class="btn btn-success" onclick="approveOrgAddRequest(${request.id})">Одобрить</button>
                            <button class="btn btn-danger" onclick="rejectOrgAddRequest(${request.id})">Отклонить</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function displayOwners(owners) {
            const tbody = document.getElementById('ownersTable');
            tbody.innerHTML = owners.map(owner => `
                <tr>
                    <td>${owner.id}</td>
                    <td>${owner.full_name}</td>
                    <td>${owner.email}</td>
                    <td>${owner.organization_name || 'Не указана'}</td>
                    <td>
                        <span class="badge ${owner.is_active ? 'badge-success' : 'badge-danger'}">
                            ${owner.is_active ? 'Активен' : 'Неактивен'}
                        </span>
                    </td>
                    <td>${new Date(owner.created_at).toLocaleDateString()}</td>
                    <td>
                        ${owner.is_active ? `
                            <button class="btn btn-danger" onclick="deactivateOwner(${owner.id})">Деактивировать</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function approveRequest(id) {
  try {
    const response = await fetch(`${API_BASE_URL}/admin/pending-requests/${id}/approve`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({}) // ← Добавьте пустое тело
    });

    if (response.ok) {
      showAlert('pendingAlert', 'Заявка одобрена', 'success');
      loadPendingRequests();
    } else {
      const data = await response.json();
      showAlert('pendingAlert', data.error, 'error');
    }
  } catch (error) {
    showAlert('pendingAlert', 'Ошибка подключения к серверу', 'error');
  }
}

        async function rejectRequest(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/pending-requests/${id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showAlert('pendingAlert', 'Заявка отклонена', 'success');
                    loadPendingRequests();
                } else {
                    const data = await response.json();
                    showAlert('pendingAlert', data.error, 'error');
                }
            } catch (error) {
                showAlert('pendingAlert', 'Ошибка подключения к серверу', 'error');
            }
        }

        async function approveOrgAddRequest(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/organization-add-requests/${id}/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showAlert('orgAddRequestsAlert', 'Заявка одобрена, организация создана', 'success');
                    loadOrganizationAddRequests();
                } else {
                    const data = await response.json();
                    showAlert('orgAddRequestsAlert', data.error, 'error');
                }
            } catch (error) {
                showAlert('orgAddRequestsAlert', 'Ошибка подключения к серверу', 'error');
            }
        }

        async function rejectOrgAddRequest(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/organization-add-requests/${id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showAlert('orgAddRequestsAlert', 'Заявка отклонена', 'success');
                    loadOrganizationAddRequests();
                } else {
                    const data = await response.json();
                    showAlert('orgAddRequestsAlert', data.error, 'error');
                }
            } catch (error) {
                showAlert('orgAddRequestsAlert', 'Ошибка подключения к серверу', 'error');
            }
        }

        async function deactivateOwner(id) {
            if (confirm('Вы уверены, что хотите деактивировать этого владельца?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/owners/${id}/deactivate`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        showAlert('ownersAlert', 'Владелец деактивирован', 'success');
                        loadOwners();
                    } else {
                        const data = await response.json();
                        showAlert('ownersAlert', data.error, 'error');
                    }
                } catch (error) {
                    showAlert('ownersAlert', 'Ошибка подключения к серверу', 'error');
                }
            }
        }

        // Модальные окна организаций
        function openAddOrganizationModal() {
            isEditing = false;
            document.getElementById('modalTitle').textContent = 'Добавить организацию';
            document.getElementById('organizationForm').reset();
            document.getElementById('orgId').value = '';
            document.getElementById('organizationModal').classList.remove('d-none');
        }

        async function editOrganization(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/organizations/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const org = data.organization;
                    
                    document.getElementById('orgId').value = org.id;
                    document.getElementById('orgName').value = org.name || '';
                    document.getElementById('orgMainService').value = org.main_service || '';
                    document.getElementById('orgCategory').value = org.category_id || '';
                    document.getElementById('orgDescription').value = org.description || '';
                    document.getElementById('orgAddress').value = org.address || '';
                    document.getElementById('orgPhone').value = org.phone || '';
                    document.getElementById('orgEmail').value = org.email || '';
                    document.getElementById('orgWebsite').value = org.website || '';
                    document.getElementById('orgServices').value = org.services || '';
                    document.getElementById('orgTags').value = Array.isArray(org.tags) ? org.tags.join(', ') : '';
                    document.getElementById('orgIsActive').checked = org.is_active;
                    
                    // Контактное лицо
                    document.getElementById('contactPersonName').value = org.contact_person_name || '';
                    document.getElementById('contactPersonRole').value = org.contact_person_role || '';
                    document.getElementById('contactPersonPhone').value = org.contact_person_phone || '';
                    document.getElementById('contactPersonEmail').value = org.contact_person_email || '';
                    document.getElementById('contactPersonPhoto').value = org.contact_person_photo_url || '';
                    
                    isEditing = true;
                    document.getElementById('modalTitle').textContent = 'Редактировать организацию';
                    document.getElementById('organizationModal').classList.remove('d-none');
                }
            } catch (error) {
                console.error('Ошибка загрузки организации:', error);
            }
        }

        async function handleOrganizationFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                main_service: formData.get('main_service'),
                category_id: parseInt(formData.get('category_id')),
                description: formData.get('description'),
                address: formData.get('address'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                website: formData.get('website'),
                services: formData.get('services'),
                tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                is_active: document.getElementById('orgIsActive').checked,
                contact_person_name: formData.get('contact_person_name'),
                contact_person_role: formData.get('contact_person_role'),
                contact_person_phone: formData.get('contact_person_phone'),
                contact_person_email: formData.get('contact_person_email'),
                contact_person_photo_url: formData.get('contact_person_photo_url')
            };
            
            try {
                const url = isEditing ? 
                    `${API_BASE_URL}/admin/organizations/${document.getElementById('orgId').value}` : 
                    `${API_BASE_URL}/admin/organizations`;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    closeOrganizationModal();
                    loadOrganizations(currentPage);
                    loadCategories();
                    showAlert('organizationsAlert', result.message, 'success');
                } else {
                    showAlert('organizationAlert', result.error, 'error');
                }
            } catch (error) {
                showAlert('organizationAlert', 'Ошибка подключения к серверу', 'error');
            }
        }

        function closeOrganizationModal() {
            document.getElementById('organizationModal').classList.add('d-none');
        }

        async function deleteOrganization(id) {
            if (confirm('Вы уверены, что хотите удалить эту организацию?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/organizations/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        loadOrganizations(currentPage);
                        showAlert('organizationsAlert', 'Организация удалена', 'success');
                    } else {
                        const data = await response.json();
                        showAlert('organizationsAlert', data.error, 'error');
                    }
                } catch (error) {
                    showAlert('organizationsAlert', 'Ошибка подключения к серверу', 'error');
                }
            }
        }

        // Модальные окна категорий
        function openAddCategoryModal() {
            isEditing = false;
            document.getElementById('categoryModalTitle').textContent = 'Добавить категорию';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryModal').classList.remove('d-none');
        }

        async function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (category) {
                document.getElementById('categoryId').value = category.id;
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryDescription').value = category.description || '';
                isEditing = true;
                document.getElementById('categoryModalTitle').textContent = 'Редактировать категорию';
                document.getElementById('categoryModal').classList.remove('d-none');
            }
        }

        async function handleCategoryFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description')
            };
            
            try {
                const url = isEditing ? 
                    `${API_BASE_URL}/admin/categories/${document.getElementById('categoryId').value}` : 
                    `${API_BASE_URL}/admin/categories`;
                const method = isEditing ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (response.ok) {
                    closeCategoryModal();
                    loadCategories();
                    showAlert('categoriesAlert', result.message, 'success');
                } else {
                    showAlert('categoryAlert', result.error, 'error');
                }
            } catch (error) {
                showAlert('categoryAlert', 'Ошибка подключения к серверу', 'error');
            }
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.add('d-none');
        }

        async function deleteCategory(id) {
            if (confirm('Вы уверены, что хотите удалить эту категорию?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/categories/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        loadCategories();
                        showAlert('categoriesAlert', 'Категория удалена', 'success');
                    } else {
                        const data = await response.json();
                        showAlert('categoriesAlert', data.error, 'error');
                    }
                } catch (error) {
                    showAlert('categoriesAlert', 'Ошибка подключения к серверу', 'error');
                }
            }
        }

        // Утилиты
        function showAlert(containerId, message, type) {
            const alertContainer = document.getElementById(containerId);
            alertContainer.className = `alert alert-${type}`;
            alertContainer.textContent = message;
            alertContainer.classList.remove('d-none');
            
            // Автоматически скрываем через 5 секунд
            setTimeout(() => {
                alertContainer.classList.add('d-none');
            }, 5000);
        }
    </script>
</body>
</html>
